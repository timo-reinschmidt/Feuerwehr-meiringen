{% extends "base.html" %}
{% block content %}
<section class="max-w-5xl mx-auto py-12 px-4 bg-fwbeige" x-data="einsaetzeApp()" x-init="load()">
    <div class="flex justify-between items-center mb-4">
        <a href="/admin" class="bg-gray-100 hover:bg-gray-200 text-sm px-3 py-1 rounded">
            ← Zurück zum Dashboard
        </a>

        <a href="/" class="bg-fwrot text-white text-sm px-3 py-1 rounded hover:bg-red-600">
            🔒 Logout
        </a>
    </div>
    <h1 class="text-3xl font-bold mb-6 text-fwrot">🧯 Einsätze verwalten</h1>

    <div class="flex flex-wrap gap-4 mb-6">
        <template x-for="jahr in sortierteJahre" :key="jahr">
            <button @click="addEinsatz(jahr)"
                    class="bg-fworange hover:bg-fwrot text-white px-3 py-1 rounded text-sm">
                ➕ Einsatz hinzufügen für <span x-text="jahr"></span>
            </button>
        </template>
    </div>

    <div class="mb-6 flex flex-wrap gap-4 items-center justify-between">
        <div class="flex gap-2">
            <input type="text" x-model="neuesJahr" class="border p-1 rounded" placeholder="Neues Jahr (z. B. 2026)">
            <button @click="addJahr" class="bg-fwrot text-white px-3 py-1 rounded">📅 Neues Jahr anlegen</button>
        </div>
        <div>
            <button @click="save()" class="bg-fworange hover:bg-fwrot text-white font-bold py-2 px-4 rounded">
                💾 Änderungen speichern
            </button>
            <span class="ml-4 text-green-600" x-text="message"></span>
        </div>
    </div>

    <!-- Aktuelles Jahr direkt anzeigen -->
    <template x-if="sortierteJahre.includes(new Date().getFullYear().toString())">
        <div class="mb-10">
            <h2 class="text-xl font-semibold mb-4" x-text="'Einsätze ' + new Date().getFullYear()"></h2>
            <template x-for="(e, index) in einsaetze[new Date().getFullYear().toString()]" :key="e.id || index">
                <div class="bg-fwbeige p-4 mb-2 rounded shadow border-l-4 border-fwrot space-y-1">
                    <p class="text-sm font-mono text-gray-600"
                       x-text="'Einsatznummer: ' + e.nr"></p>
                    <input type="date" class="w-full p-1 rounded border" x-model="e.datum">
                    <input type="text" class="w-full p-1 rounded border" x-model="e.titel" placeholder="Titel">
                    <textarea class="w-full p-1 rounded border" x-model="e.beschreibung"
                              placeholder="Beschreibung (optional)"></textarea>
                    <button @click="deleteEinsatz(e.datum.split('-')[0], index, e.id)"
                            class="text-sm text-red-600 mt-2">🗑️ Löschen
                    </button>
                </div>
            </template>
        </div>
    </template>

    <!-- Archiv: alle früheren Jahre einklappbar -->
    <h2 class="text-xl font-semibold mb-4 text-fwrot mt-10">📁 Archiv</h2>
    <template x-for="jahr in sortierteJahre.filter(j => j !== new Date().getFullYear().toString())" :key="jahr">
        <details class="mb-6">
            <summary class="cursor-pointer font-semibold bg-white p-2 rounded shadow border text-fwrot">
                Archiv: <span x-text="jahr"></span>
            </summary>
            <div class="mt-4">
                <template x-for="(e, index) in einsaetze[jahr]" :key="e.id || index">
                    <div class="bg-fwbeige p-4 mb-2 rounded shadow border-l-4 border-fwrot space-y-1">
                        <p class="text-sm font-mono text-gray-600"
                           x-text="'Einsatznummer: ' + e.nr"></p>
                        <input type="text" class="w-full p-1 rounded border" x-model="e.datum" placeholder="Datum">
                        <input type="text" class="w-full p-1 rounded border" x-model="e.titel" placeholder="Titel">
                        <textarea class="w-full p-1 rounded border" x-model="e.beschreibung"
                                  placeholder="Beschreibung (optional)"></textarea>
                        <button @click="deleteEinsatz(jahr, index, e.id)" class="text-sm text-red-600 mt-2">🗑️ Löschen
                        </button>
                    </div>
                </template>
            </div>
        </details>
    </template>

    <div class="mt-6 bg-fwbeige">
        <button @click="save()" class="bg-fworange hover:bg-fwrot text-white font-bold py-2 px-4 rounded">
            💾 Änderungen speichern
        </button>
        <span class="ml-4 text-green-600" x-text="message"></span>
    </div>
</section>

<script>
    function einsaetzeApp() {
        return {
            einsaetze: {},
            neuesJahr: '',
            message: '',

            async load() {
                const res = await fetch('/api/einsaetze');
                const data = await res.json();
                const grouped = {};
                data.forEach(e => {
                    const jahr = e.datum.split('-')[0];
                    if (!grouped[jahr]) grouped[jahr] = [];
                    grouped[jahr].push(e);
                });
                // Alle Listen absteigend sortieren
                for (const jahr in grouped) {
                    grouped[jahr].sort((a, b) => b.datum.localeCompare(a.datum));
                }
                this.einsaetze = grouped;
            },

            get sortierteJahre() {
                return Object.keys(this.einsaetze).sort((a, b) => b - a);
            },

            async addEinsatz(jahr) {
                const jahrKurz = jahr.slice(-2);
                const vorhandene = this.einsaetze[jahr]
                    .map(e => parseInt(e.nr?.split('/')?.[0]))
                    .filter(n => !isNaN(n));
                const maxNr = vorhandene.length ? Math.max(...vorhandene) : 0;
                const neueNr = String(maxNr + 1).padStart(2, '0') + '/' + jahrKurz;

                const dummy = {
                    datum: new Date().toISOString().slice(0, 10),
                    nr: neueNr,
                    titel: '',
                    beschreibung: ''
                };

                const res = await fetch('/api/einsaetze', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(dummy)
                });

                const result = await res.json();
                dummy.id = result.id;

                if (!this.einsaetze[jahr]) this.einsaetze[jahr] = [];
                // ← direkt lokal einfügen
            },

            async deleteEinsatz(jahr, index, id) {
                if (id) {
                    await fetch(`/api/einsaetze/${id}`, {method: 'DELETE'});
                }
                this.einsaetze[jahr].splice(index, 1);
            },

            addJahr() {
                if (this.neuesJahr && !this.einsaetze[this.neuesJahr]) {
                    this.einsaetze[this.neuesJahr] = [];
                    this.neuesJahr = '';
                }
            },

            async save() {
                for (const jahr of this.sortierteJahre) {
                    // Alle Einsätze dieses Jahres nach Datum sortieren
                    const sortiert = [...this.einsaetze[jahr]].sort((a, b) => a.datum.localeCompare(b.datum));
                    const jahrKurz = jahr.slice(-2);

                    // Neu durchnummerieren
                    sortiert.forEach((e, i) => {
                        e.nr = String(i + 1).padStart(2, '0') + '/' + jahrKurz;
                    });

                    // Zurückschreiben in das Hauptobjekt
                    this.einsaetze[jahr] = sortiert;

                    // Speichern in die Datenbank
                    for (const einsatz of sortiert) {
                        if (!einsatz.id) continue;
                        await fetch(`/api/einsaetze/${einsatz.id}`, {
                            method: 'PUT',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify(einsatz)
                        });
                    }
                }

                this.message = '✅ Nummerierung aktualisiert & gespeichert!';
                setTimeout(() => this.message = '', 3000);
            }
        }
    }
</script>
{% endblock %}