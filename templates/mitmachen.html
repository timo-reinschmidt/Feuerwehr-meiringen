{% extends 'base.html' %}

{% block content %}
<!-- Hero -->
<section class="relative h-[50vh] min-h-[300px] flex items-center justify-center bg-cover bg-center"
         style="background-image: url('/static/images/mitmachen-header.jpg');">
    <div class="absolute inset-0 bg-black/50"></div>
    <div class="relative z-10 text-white text-center px-4">
        <h1 class="text-4xl md:text-5xl font-bold drop-shadow">Mitmachen & Ausbildung</h1>
        <p class="text-md md:text-xl mt-2 drop-shadow">Dein Weg ins Feuerwehr-Team Meiringen.</p>
    </div>
</section>

<!-- Einstieg mit Fragen & Akkordeon -->
<section class="py-16 bg-fwbeige">
    <div class="max-w-6xl mx-auto px-4 grid md:grid-cols-2 gap-8 items-start">
        <div>
            <h2 class="text-xl font-bold text-fwrot mb-4">Bist du ein <span class="italic">Retter</span> oder eine <span
                    class="italic">Retterin</span>?</h2>
            <ul class="list-disc list-inside text-gray-800 space-y-4">
                <li>Faszinierst du dich für die Welt der Feuerwehr und möchtest aktiv zur Sicherheit unserer
                    Gesellschaft beitragen?
                </li>
                <li>Suchst du ein kameradschaftliches Umfeld mit klarer Struktur und wichtiger Mission?</li>
            </ul>
            <p class="mt-6 text-gray-900">Wir suchen laufend top motivierte Feuerwehrfrauen und Feuerwehrmänner, die
                unser eingespieltes Korps ergänzen.</p>
            <p class="text-2xl font-semibold mt-4 text-fworange">Wir suchen DICH!</p>
        </div>

        <div x-data="{ open: null }" class="space-y-4">
            <!-- Schritt 1: Kontaktformular -->
            <div class="border border-gray-300 rounded overflow-hidden">
                <button @click="open === 0 ? open = null : open = 0"
                        class="w-full text-left px-4 py-3 font-semibold bg-white hover:bg-gray-100">
                    1. Interesse? Kontaktiere uns jetzt!
                </button>
                <div x-show="open === 0" x-collapse class="bg-black text-white px-4 py-6 text-sm">
                    <p class="mb-4">Fülle als erstes bitte das Formular vollständig aus.</p>
                    <h3 class="text-xl font-bold uppercase mb-2">Anforderungen</h3>
                    <p class="mb-4">Bist du bereit pro Jahr mindestens 8 Ausbildungsübungen à 2 Stunden zu
                        bestreiten?</p>
                    <div class="flex gap-6 mb-6">
                        <label class="flex items-center gap-2">
                            <input type="radio" name="verpflichtung" value="ja" class="accent-fworange"> Ja
                        </label>
                        <label class="flex items-center gap-2">
                            <input type="radio" name="verpflichtung" value="nein" class="accent-fworange"> Nein
                        </label>
                    </div>

                    <form action="/mitmachen" method="POST" class="grid md:grid-cols-2 gap-4 text-black">
                        <input type="text" name="name" placeholder="Name *" required class="p-2 rounded border">
                        <input type="text" name="vorname" placeholder="Vorname *" required class="p-2 rounded border">
                        <input type="text" name="address" placeholder="Strasse / Nr. *" required
                               class="p-2 rounded border">
                        <input type="text" name="plz" placeholder="PLZ / Ort *" required class="p-2 rounded border">
                        <input type="text" name="geburtstag" placeholder="Geburtsdatum *" required
                               class="p-2 rounded border">
                        <input type="text" name="handy" placeholder="Telefon Privat / Mobile *" required
                               class="p-2 rounded border">
                        <input type="email" name="email" placeholder="E-Mail *" required class="p-2 rounded border">
                        <input type="text" name="beruf" placeholder="Beruf *" required class="p-2 rounded border">
                        <input type="text" name="arbeitsort" placeholder="Arbeitsort *" required
                               class="p-2 rounded border">

                        <div class="md:col-span-2 space-y-2 mt-4 text-white">
                            <label class="flex items-center gap-2">
                                <input type="checkbox" class="h-4 w-4"> Ich interessiere mich für das Rekrutenjahr
                            </label>
                            <label class="flex items-center gap-2">
                                <input type="checkbox" class="h-4 w-4"> Ich habe bereits Feuerwehrdienst geleistet
                            </label>

                            <h3 class="font-semibold mt-4 text-xl">Absolvierte Ausbildungen</h3>
                            <label class="flex items-center gap-2">
                                <input type="checkbox" class="h-4 w-4"> Basiskurs
                            </label>
                            <label class="flex items-center gap-2">
                                <input type="checkbox" class="h-4 w-4"> Atemschutz / KG
                            </label>
                            <label class="flex items-center gap-2">
                                <input type="checkbox" class="h-4 w-4"> TLF-Fahrer resp. C Ausweis
                            </label>
                            <label class="flex items-center gap-2">
                                <input type="checkbox" class="h-4 w-4"> Gruppenführer
                            </label>
                            <label class="flex items-center gap-2">
                                <input type="checkbox" class="h-4 w-4"> Einsatzleiter
                            </label>

                            <label class="block mt-4 font-semibold">Weitere Kurse</label>
                            <textarea placeholder="Weitere relevante Kurse oder Erfahrungen"
                                      class="w-full p-2 rounded border h-24"></textarea>
                        </div>

                        <textarea name="bemerkung" placeholder="Bemerkung"
                                  class="md:col-span-2 p-2 rounded border h-24 mt-4"></textarea>

                        <button type="submit"
                                class="md:col-span-2 mt-2 bg-fworange hover:bg-fwrot text-white font-bold py-2 px-4 rounded">
                            ▶ Senden
                        </button>
                    </form>
                </div>
            </div>

            <!-- Schritte 2–4 -->
            <template x-for="(item, index) in [
                { title: '2. Besuche unseren nächsten Info-Abend', content: 'Du erhältst einen Einblick in unsere Aufgaben, Organisation und Einsatzabläufe.' },
                { title: '3. Lernen wir uns bei einem Gespräch kennen', content: 'Wir klären gemeinsam deine Motivation, Eignung und Möglichkeiten.' },
                { title: '4. Du erhältst Bescheid der Feuerwehrkommission', content: 'Nach dem Entscheid startest du deine Grundausbildung bei uns.' }
            ]" :key="index">
                <div class="border border-gray-300 rounded overflow-hidden">
                    <button @click="open === index + 1 ? open = null : open = index + 1"
                            class="w-full text-left px-4 py-3 font-semibold bg-white hover:bg-gray-100">
                        <span x-text="item.title"></span>
                    </button>
                    <div x-show="open === index + 1" x-collapse class="px-4 py-3 text-sm text-gray-800 bg-gray-50">
                        <span x-text="item.content"></span>
                    </div>
                </div>
            </template>
        </div>
    </div>
</section>

<!-- EINZIGE Termine-Komponente -->
<section class="py-16 bg-white" x-data="termineApp()" x-init="init()">
    <div class="max-w-6xl mx-auto px-4">
        <div class="mb-6 flex flex-wrap gap-4 items-center justify-between">
            <h2 class="text-2xl font-semibold text-fwrot">Terminkalender 2025</h2>
            <select x-model="filter" class="p-2 rounded border">
                <option value="">Alle Gruppen</option>
                <template x-for="gruppe in gruppen" :key="gruppe">
                    <option :value="gruppe" x-text="gruppenLabels[gruppe] || gruppe"></option>
                </template>
            </select>
        </div>

        <!-- Zukünftige Termine -->
        <template x-for="(eintraege, monat) in gruppiereNachMonat(zukunftsTermine)" :key="monat">
            <div class="mb-10">
                <h3 class="text-xl font-bold mb-4 text-fwblack" x-text="monat"></h3>
                <div class="grid md:grid-cols-3 gap-6">
                    <template x-for="eintrag in eintraege" :key="eintrag.id">
                        <div class="bg-fwbeige p-4 rounded shadow border-l-4 border-fworange">
                            <p class="text-sm text-gray-500" x-text="eintrag.datum + ' (' + eintrag.tag + ')' "></p>
                            <h4 class="font-bold text-lg mb-1">
                                Thema: <span x-text="eintrag.thema"></span>
                            </h4>
                            <p class="text-sm text-gray-700" x-show="eintrag.bezeichnung"><strong>Bezeichnung:</strong>
                                <span x-text="eintrag.bezeichnung"></span></p>
                            <p class="text-sm text-gray-700" x-show="eintrag.schwerpunkt"><strong>Schwerpunkt:</strong>
                                <span x-text="eintrag.schwerpunkt"></span></p>
                            <p class="text-sm text-gray-700" x-show="eintrag.verantwortlich">
                                <strong>Verantwortlich:</strong> <span x-text="eintrag.verantwortlich"></span></p>
                            <p class="text-sm text-gray-700"><strong>Ort:</strong> <span x-text="eintrag.ort"></span>
                            </p>
                            <p class="text-sm text-gray-700"><strong>Zeit:</strong> <span x-text="eintrag.zeit"></span>
                            </p>
                            <p class="text-xs mt-2 text-gray-400" x-text="'Gruppe: ' + eintrag.basisgruppe"></p>
                        </div>
                    </template>
                </div>
            </div>
        </template>

        <!-- Archiv -->
        <div class="mt-12 border-t pt-10">
            <button @click="openArchiv = !openArchiv" class="text-fwrot font-semibold text-lg mb-4">
                📂 Archiv ein-/ausklappen
            </button>
            <div x-show="openArchiv" x-collapse>
                <template x-for="(eintraege, jahr) in gruppiereNachJahr(vergangeneTermine)" :key="jahr">
                    <div class="mb-6">
                        <h3 class="font-bold text-fwblack mb-2" x-text="jahr"></h3>
                        <div class="grid md:grid-cols-3 gap-6">
                            <template x-for="(eintrag, index) in eintraege" :key="index">
                                <div class="bg-white p-4 rounded shadow border-l-4 border-gray-300">
                                    <p class="text-sm text-gray-500"
                                       x-text="eintrag.datum + ' (' + eintrag.tag + ')' "></p>
                                    <h4 class="font-bold text-lg mb-1" x-text="eintrag.bezeichnung"></h4>
                                    <p class="text-sm text-gray-700" x-show="eintrag.thema"><strong>Thema:</strong>
                                        <span x-text="eintrag.thema"></span></p>
                                    <p class="text-sm text-gray-700" x-show="eintrag.schwerpunkt">
                                        <strong>Schwerpunkt:</strong> <span x-text="eintrag.schwerpunkt"></span></p>
                                    <p class="text-sm text-gray-700" x-show="eintrag.verantwortlich"><strong>Verantwortlich:</strong>
                                        <span x-text="eintrag.verantwortlich"></span></p>
                                    <p class="text-sm text-gray-700"><strong>Ort:</strong> <span
                                            x-text="eintrag.ort"></span></p>
                                    <p class="text-sm text-gray-700"><strong>Zeit:</strong> <span
                                            x-text="eintrag.zeit"></span></p>
                                    <p class="text-xs mt-2 text-gray-400" x-text="'Gruppe: ' + eintrag.basisgruppe"></p>
                                </div>
                            </template>
                        </div>
                    </div>
                </template>
            </div>
        </div>
    </div>
</section>

<!-- Alpine-Komponente -->
<script>
    function termineApp() {
        return {
            termine: [],
            filter: '',
            openArchiv: false,
            loaded: false,
            gruppenLabels: {
                AS: 'Atemschutz',
                OW: 'Ölwehr',
                PbU: 'PbU',
                Of: 'Offiziere',
                Kdo: 'Kommando',
                Beso: 'Besondere',
                FDV: 'Fahrdienst',
                Alle: 'Alle'
            },
            async init() {
                if (this.loaded) return;
                this.loaded = true;
                const res = await fetch('/api/termine');
                const data = await res.json();
                const seen = new Set();
                this.termine = data.filter(entry => {
                    if (seen.has(entry.id)) return false;
                    seen.add(entry.id);
                    return true;
                }).map(eintrag => {
                    const raw = eintrag.gruppe || "";
                    const basisgruppe = raw.split(".")[0].split("/")[0];
                    return {...eintrag, basisgruppe};
                });
            },
            get gruppen() {
                const gruppen = new Set(this.termine.map(e => e.basisgruppe).filter(Boolean));
                return Array.from(gruppen).sort();
            },
            get zukunftsTermine() {
                const heute = new Date();
                return this.termine.filter(e => new Date(e.datum) >= heute);
            },
            get vergangeneTermine() {
                const heute = new Date();
                return this.termine.filter(e => new Date(e.datum) < heute);
            },
            gruppiereNachMonat(eintraege) {
                const filtered = this.filter
                    ? eintraege.filter(e => e.basisgruppe === this.filter)
                    : eintraege;
                const gruppiert = {};
                for (const eintrag of filtered) {
                    const monat = new Date(eintrag.datum).toLocaleString('de-CH', {month: 'long', year: 'numeric'});
                    if (!gruppiert[monat]) gruppiert[monat] = [];
                    gruppiert[monat].push(eintrag);
                }
                return gruppiert;
            },
            gruppiereNachJahr(eintraege) {
                const filtered = this.filter
                    ? eintraege.filter(e => e.basisgruppe === this.filter)
                    : eintraege;
                const gruppiert = {};
                for (const eintrag of filtered) {
                    const jahr = new Date(eintrag.datum).getFullYear();
                    if (!gruppiert[jahr]) gruppiert[jahr] = [];
                    gruppiert[jahr].push(eintrag);
                }
                return gruppiert;
            }
        };
    }
</script>
{% endblock %}